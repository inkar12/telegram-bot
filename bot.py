# === bot.py (Refactored for python-telegram-bot v20.6) ===
import os
from dotenv import load_dotenv
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    ContextTypes, filters
)

load_dotenv()
TOKEN = os.getenv("BOT_TOKEN")

# === QUIZ LOGIC ===
questions = [
    {
        "text": "1\u20e3\ufe0f –ö–∞–∫–æ–π —É —Ç–µ–±—è —Å—Ä–µ–¥–Ω–∏–π GPA –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –≥–æ–¥–∞?",
        "options": ["–ù–∏–∂–µ 2.5", "2.5‚Äì3.3", "3.4‚Äì3.8", "3.9‚Äì4.0"],
        "scores": [0, 1, 2, 3],
    },
    {
        "text": "2\u20e3\ufe0f –ö–∞–∫ —Ç—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—à—å —Å–≤–æ–∏ –≤–Ω–µ–∫–ª–∞—Å—Å–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—Å–ø–æ—Ä—Ç, –≤–æ–ª–æ–Ω—Ç–µ—Ä—Å—Ç–≤–æ, –ø—Ä–æ–µ–∫—Ç—ã)?",
        "options": [
            "–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π",
            "–ï—Å—Ç—å –±–∞–∑–æ–≤—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏",
            "–•–æ—Ä–æ—à–∏–π —É—Ä–æ–≤–µ–Ω—å —É—á–∞—Å—Ç–∏—è",
            "–Ø –ª–∏–¥–µ—Ä/—Å–æ–∑–¥–∞—Ç–µ–ª—å –≤ —á–µ–º-—Ç–æ",
        ],
        "scores": [0, 1, 2, 3],
    },
    {
        "text": "3\u20e3\ufe0f –£ —Ç–µ–±—è –µ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞?",
        "options": [
            "–ù–µ—Ç, –≤–æ–æ–±—â–µ",
            "–£—á—É—Å—å, –Ω–æ –±–µ–∑ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤",
            "–ì–æ—Ç–æ–≤–ª—é—Å—å –∫ IELTS/TOEFL",
            "–£–∂–µ –µ—Å—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç",
        ],
        "scores": [0, 1, 2, 3],
    },
    {
        "text": "4\u20e3\ufe0f –¢—ã –∑–Ω–∞–µ—à—å, –∫—É–¥–∞ –∏–º–µ–Ω–Ω–æ —Ö–æ—á–µ—à—å –ø–æ—Å—Ç—É–ø–∞—Ç—å?",
        "options": [
            "–í–æ–æ–±—â–µ –Ω–µ—Ç",
            "–ï—Å—Ç—å –ø—Ä–∏–º–µ—Ä–Ω—ã–µ –∏–¥–µ–∏",
            "–í—ã–±—Ä–∞–ª —Å—Ç—Ä–∞–Ω—É –∏ —Ç–∏–ø –≤—É–∑–∞",
            "–ï—Å—Ç—å —á—ë—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ –≤—É–∑–æ–≤",
        ],
        "scores": [0, 1, 2, 3],
    },
    {
        "text": "5\u20e3\ufe0f –ö–∞–∫ —Ç—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—à—å —Å–≤–æ–∏ —à–∞–Ω—Å—ã –Ω–∞ —Å—Ç–∏–ø–µ–Ω–¥–∏—é?",
        "options": [
            "–ù–µ –≤–µ—Ä—é, —á—Ç–æ –ø–æ–ª—É—á—É",
            "–°–æ–º–Ω–µ–≤–∞—é—Å—å, –Ω–æ —Ö–æ—á—É",
            "–î—É–º–∞—é, –µ—Å—Ç—å —à–∞–Ω—Å",
            "–£–≤–µ—Ä–µ–Ω(–∞) –≤ —Å–µ–±–µ",
        ],
        "scores": [0, 1, 2, 3],
    },
    {
        "text": "6\u20e3\ufe0f –ö–∞–∫ —Ç—ã —Ä–µ–∞–≥–∏—Ä—É–µ—à—å, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–∫–∞–∑ –≤ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –∏–ª–∏ –ø–ª–æ—Ö–∞—è –æ—Ü–µ–Ω–∫–∞?",
        "options": [
            "–û—Å–º—ã—Å–ª–∏–≤–∞—é –∏ —Å—Ç—Ä–æ—é –ø–ª–∞–Ω –∫–∞–º–±—ç–∫–∞",
            "–°–æ–º–Ω–µ–≤–∞—é—Å—å, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—é –¥–≤–∏–≥–∞—Ç—å—Å—è",
            "–ú–∞—Ö–∞—é —Ä—É–∫–æ–π ‚Äî –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å –¥—Ä—É–≥–æ–π –ø—É—Ç—å",
            "–≠—Ç–æ —Å–∏–ª—å–Ω–æ –∑–∞–¥–µ–≤–∞–µ—Ç, –º–Ω–µ –Ω—É–∂–Ω–æ –≤—Ä–µ–º—è",
        ],
        "scores": [3, 2, 1, 0],
    },
    {
        "text": "7\u20e3\ufe0f –ß—Ç–æ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç —Ç–µ–±—è –ø–æ—Å—Ç—É–ø–∞—Ç—å –∑–∞ –≥—Ä–∞–Ω–∏—Ü—É?",
        "options": [
            "–°–≤–æ–±–æ–¥–∞ –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å",
            "–°–¥–µ–ª–∞—Ç—å —Å–µ–º—å—é –≥–æ—Ä–¥–æ–π",
            "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–æ—â–Ω–æ–µ –±—É–¥—É—â–µ–µ",
            "–ù–∞–π—Ç–∏ —Å–µ–±—è –∏ –ø–æ–Ω—è—Ç—å, –∫—Ç–æ —è",
        ],
        "scores": [2, 1, 3, 2],
    },
    {
        "text": "8\u20e3\ufe0f –ß—Ç–æ –¥–ª—è —Ç–µ–±—è –±—É–¥–µ—Ç —Å–∞–º—ã–º –≤–∞–∂–Ω—ã–º –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —É—á—ë–±—ã?",
        "options": [
            "–û–∫–∞–∑—ã–≤–∞—Ç—å –≤–ª–∏—è–Ω–∏–µ –∏ –º–µ–Ω—è—Ç—å –º–∏—Ä",
            "–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ö–æ—Ä–æ—à–æ",
            "–ñ–∏—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ, –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π",
            "–û—Å—Ç–∞—Ç—å—Å—è –≤–µ—Ä–Ω—ã–º(–æ–π) —Å–µ–±–µ",
        ],
        "scores": [3, 2, 1, 2],
    },
]

user_scores = {}
user_steps = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_scores[user_id] = 0
    user_steps[user_id] = 0
    await send_question(update, context)

async def send_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    step = user_steps[user_id]
    q = questions[step]
    markup = ReplyKeyboardMarkup(
        [[o] for o in q["options"]], one_time_keyboard=True, resize_keyboard=True
    )
    await context.bot.send_message(chat_id=user_id, text=q["text"], reply_markup=markup)

async def answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id

    if user_id not in user_steps:
        await context.bot.send_message(chat_id=user_id, text="–ü—Ä–∏–≤–µ—Ç! –û—Ç–ø—Ä–∞–≤—å /start —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∫–≤–∏–∑.")
        return

    step = user_steps[user_id]
    q = questions[step]

    if update.message.text not in q["options"]:
        await context.bot.send_message(chat_id=user_id, text="–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.")
        return

    idx = q["options"].index(update.message.text)
    user_scores[user_id] += q["scores"][idx]
    user_steps[user_id] += 1

    if user_steps[user_id] < len(questions):
        await send_question(update, context)
    else:
        score = user_scores[user_id]
        if score <= 8:
            msg = "üü° –¢—ã ‚Äî –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å.\n–¢—ã —Ç–æ–ª—å–∫–æ –≤ –Ω–∞—á–∞–ª–µ –ø—É—Ç–∏ –∏ —Ç–µ–±–µ –≤–∞–∂–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è—Ö –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è—Ö.\n–ù–æ —ç—Ç–æ —É–∂–µ –æ—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ!"
        elif score <= 16:
            msg = "üü¢ –¢—ã ‚Äî –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç.\n–£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∏–¥–µ–∏ –∏ –Ω–∞–≤—ã–∫–∏. –ù–µ–º–Ω–æ–≥–æ —É—Å–∏–ª–∏–π ‚Äî –∏ —Ç—ã —Å–º–æ–∂–µ—à—å —Å–æ–±—Ä–∞—Ç—å —Å–∏–ª—å–Ω–æ–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –∏ –≤—ã–∏–≥—Ä–∞—Ç—å –≥—Ä–∞–Ω—Ç."
        else:
            msg = "üîµ –¢—ã ‚Äî –ì–æ—Ç–æ–≤—ã–π –∞–ø–ø–ª–∏–∫–∞–Ω—Ç.\n–¢—ã —Å–æ–±—Ä–∞–ª –≤—Å—ë –Ω—É–∂–Ω–æ–µ –∏ –≥–æ—Ç–æ–≤ –∫ –ø–æ–¥–∞—á–µ. –° –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π —É —Ç–µ–±—è –æ—Ç–ª–∏—á–Ω—ã–µ —à–∞–Ω—Å—ã –ø–æ–ø–∞—Å—Ç—å –≤ —Ç–æ–ø-–≤—É–∑!"

        await context.bot.send_message(chat_id=user_id, text=f"–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {score}/24\n\n{msg}")
        await context.bot.send_message(chat_id=user_id, text=(
            "üéì –Ø –ø–æ—Å—Ç—É–ø–∏–ª–∞ –≤ 16 –≤—É–∑–æ–≤ –Ω–∞ –ø–æ–ª–Ω—ã–π –≥—Ä–∞–Ω—Ç –∏ —Å–µ–π—á–∞—Å —É—á—É—Å—å –≤ —Ç–æ–ø–æ–≤–æ–º liberal arts college –≤ –°–®–ê.\n\n"
            "üî∏ –ü–µ—Ä–≤—ã–π —Ä–∞–∑ ‚Äî –ø–æ—Å—Ç—É–ø–∏–ª–∞ —Ç—É–¥–∞, –∫—É–¥–∞ –Ω–µ —Ö–æ—Ç–µ–ª–∞\n"
            "üî∏ –í—Ç–æ—Ä–æ–π ‚Äî —Å–∏–ª—å–Ω–æ —Å—Ç–∞—Ä–∞–ª–∞—Å—å, –Ω–æ –≤—Å—ë –µ—â—ë –Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ\n"
            "üî∏ –¢—Ä–µ—Ç–∏–π ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç\n\n"
            "üìå –£ —Ç–µ–±—è —Ç–æ–∂–µ –ø–æ–ª—É—á–∏—Ç—Å—è!"
        ))
        await context.bot.send_message(chat_id=user_id, text="üí° –•–æ—á–µ—à—å –±–µ—Å–ø–ª–∞—Ç–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é? –ù–∞–ø–∏—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–µ–Ω–µ–¥–∂–µ—Ä—É: @speakinkschool")

app = ApplicationBuilder().token(TOKEN).build()
app.add_handler(CommandHandler("start", start))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, answer))
async def main():
    print("üöÄ Starting bot...")
    await app.initialize()
    await app.start_polling()
    await app.idle()
